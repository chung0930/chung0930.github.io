<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ•…äº‹å·¥åŠ - å®˜æ–¹å…¥å£ç¶²</title>
    <style>
        :root {
            --primary-color: #333;
            --accent-color: #007bff;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--primary-color);
            line-height: 1.6;
        }

        /* --- å°è¦½åˆ— --- */
        nav {
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        nav h1 { margin: 0; font-size: 1.5rem; }
        nav ul { list-style: none; margin: 0; padding: 0; display: flex; gap: 20px; }
        nav a { text-decoration: none; color: #555; font-weight: bold; transition: 0.3s; }
        nav a:hover { color: var(--accent-color); }

        /* --- è·‘é¦¬ç‡ˆå€å¡Š (Marquee) --- */
        #marquee-section {
            background-color: #222;
            color: #fff;
            height: 60px; /* é™åˆ¶é«˜åº¦ */
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
        }
        #scroller {
            white-space: nowrap;
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            will-change: transform;
        }

        /* --- ä¸»è¦å…§å®¹å€ Grid --- */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        
        .card h2 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; font-size: 1.25rem; }

        /* --- æ¯æ—¥é‡‘å¥æ¨£å¼ --- */
        .quote-content { text-align: center; padding: 20px 0; }
        #q-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; min-height: 3em; }
        #q-author { color: #666; font-style: italic; }
        .quote-btn {
            background-color: #333; color: #fff; border: none; padding: 8px 20px;
            border-radius: 20px; cursor: pointer; margin-top: 10px;
        }
        .quote-btn:disabled { background-color: #ccc; }

        /* --- AI èŠå¤©å®¤æ¨£å¼ --- */
        .chat-box {
            background: #f9f9f9;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #eee;
        }
        .msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; font-size: 0.9rem; }
        .msg.user { background: #d1e7ff; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg.bot { background: #ffeecf; margin-right: auto; border-bottom-left-radius: 2px; }
        .chat-input-area { display: flex; gap: 5px; }
        .chat-input-area input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .chat-input-area button { padding: 8px 15px; background: #246bff; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* --- åŠ å¯†å·¥å…·æ¨£å¼ --- */
        .crypto-box input { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box; }
        .crypto-btn { width: 100%; padding: 10px; margin-bottom: 5px; border: none; cursor: pointer; color: white; border-radius: 4px; }
        .btn-encrypt { background-color: #007bff; }
        .btn-decrypt { background-color: #28a745; }
        #crypto-status { margin-top: 10px; font-size: 0.9rem; font-weight: bold; }
        #crypto-preview img { max-width: 100%; margin-top: 10px; border: 1px solid #ddd; }

        /* --- æ•…äº‹é€£çµåˆ—è¡¨ --- */
        .story-list ul { list-style: none; padding: 0; }
        .story-list li { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .story-list a { text-decoration: none; color: #333; display: block; }
        .story-list a:hover { color: var(--accent-color); padding-left: 5px; }

        footer {
            text-align: center;
            padding: 2rem;
            background: #fff;
            color: #666;
            margin-top: 2rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <nav>
        <h1>å°æ•…äº‹å·¥åŠ</h1>
        <ul>
            <li><a href="#home">é¦–é </a></li>
            <li><a href="#stories">ä½œå“é›†</a></li>
            <li><a href="#" onclick="alert('è‚¡å¸‚åŠŸèƒ½éœ€ç¨ç«‹å…¨è¢å¹•é‹è¡Œï¼Œæ­¤ç‚ºå–®é æ¼”ç¤ºã€‚')">è™›æ“¬è‚¡å¸‚</a></li>
            <li><a href="https://docs.google.com/forms/d/1vSmn923Mdf3BVDimeJkyxZaa9-W2PevwTVyPQZrmwWc/edit?usp=drivesdk" target="_blank">æ„è¦‹å›é¥‹</a></li>
        </ul>
    </nav>

    <div id="marquee-section">
        <div id="scroller">è¼‰å…¥å…¬å‘Šä¸­...</div>
    </div>

    <div class="container" id="home">
        
        <div class="card">
            <h2>ğŸ“œ æ¯æ—¥é‡‘å¥</h2>
            <div class="quote-content">
                <div id="q-text">è¼‰å…¥ä¸­...</div>
                <div id="q-author"></div>
                <button class="quote-btn" onclick="fetchQuote()" id="q-btn">æ›ä¸€å¥</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ¤– Chat Big GG AI</h2>
            <div class="chat-box" id="messages">
                <div class="msg bot">æ‚¨å¥½ï¼Œé€™æ˜¯ä¸€å€‹ AIï¼Œè¼¸å…¥ä»»æ„æ–‡å­—å¾ŒæŒ‰é€å‡ºã€‚</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯...">
                <button onclick="handleChatSend()">é€å‡º</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ”’ æª”æ¡ˆåŠ å¯†/è§£é– (V2)</h2>
            <div class="crypto-box">
                <label>1. é¸æ“‡æª”æ¡ˆï¼š</label>
                <input type="file" id="fileInput">
                <label>2. è¼¸å…¥å¯†ç¢¼ï¼š</label>
                <input type="password" id="cryptoPwd" placeholder="è«‹è¼¸å…¥å¼·å¯†ç¢¼">
                
                <button class="crypto-btn btn-encrypt" onclick="processFile('encrypt')">ğŸ”’ åŠ å¯†ä¸¦ä¸‹è¼‰</button>
                <button class="crypto-btn btn-decrypt" onclick="processFile('decrypt')">ğŸ”“ è§£é–ä¸¦é¡¯ç¤º</button>
                
                <div id="crypto-status"></div>
                <div id="crypto-preview"></div>
            </div>
        </div>

    </div>

    <div class="container" id="stories">
        <div class="card" style="grid-column: 1 / -1;">
            <h2>ğŸ“š æ•…äº‹èˆ‡è³‡æºä¸‹è¼‰</h2>
            <div class="story-list">
                <ul>
                    <li><a href="https://drive.google.com/embeddedfolderview?id=1CAnvbMg3CB3a29L_2hxmcj0TKLvxSuBz#list" target="_blank">ğŸ“‚ å°æ•…äº‹å·¥åŠé›²ç«¯ç¡¬ç¢Ÿ V.2</a></li>
                    <li><a href="https://drive.google.com/open?id=1zmbPTlcGtdY7dvLciyAJFdjCNNYFR3W4QXJVa1tXTjg" target="_blank">ğŸ“– æ½˜èª¼ç’‡èˆ‡è”¡å‰ç´³çš„æ„›æƒ…æ—¥è¨˜.1</a></li>
                    <li><a href="https://drive.google.com/open?id=1io-24uCInuiY4H4M_eSG3Hq3BXpoCMBAg_3qsfGxy6o" target="_blank">ğŸ“– äººå¦–èˆ‡ç”°èªæ¡</a></li>
                    <li><a href="https://drive.google.com/open?id=1012yaF5SwUIAK5jY3Q_fxDAcK_Y35e8yMkugRTgXrD4" target="_blank">ğŸ“– å¾å­æµ©å¤–é‡æ•…äº‹</a></li>
                    <li><a href="https://drive.google.com/file/d/1n5QmmVQr8RDSo7cZQWz5hf5gnDwlebiq/view?usp=drivesdk" target="_blank">ğŸ® ä¸è¦æ‰“æˆ‘ (å·«å‡±ç‰¹è£½ä½œ)</a></li>
                    <li><a href="https://drive.google.com/open?id=1_0KHaGjk-1kG66hOS9rfRBMlTGHA872bE9OND11MiDA" target="_blank">ğŸ”’ é¦¬èˆ‡éª¨çš„æ„›æƒ…å².1 (åŠ å¯†ç‰ˆ)</a></li>
                    <li><a href="https://drive.google.com/open?id=11Fqc9u1XPx-z_D2sIIE2MeIuWDaqJAsOv7AX6ZOOa3Q" target="_blank">ğŸ’” æ—éƒç¿”èˆ‡é¦®äº­é–çš„æ„›æ¨æƒ…ä»‡</a></li>
                </ul>
            </div>
        </div>
    </div>

    <footer>
        <p>Copyright Â© å°æ•…äº‹å·¥åŠ. æ­¤ç¶²é ç‚ºæ¨¡æ“¬é‚„åŸç‰ˆæœ¬ã€‚</p>
        <p>è¯çµ¡ä¿¡ç®±ï¼šmzhong109002@gamil.com</p>
    </footer>

    <script>
        // ==========================================
        // 1. è·‘é¦¬ç‡ˆé‚è¼¯ (Marquee)
        // ==========================================
        const MARQUEE_API = "https://script.google.com/macros/s/AKfycbxRIYaYtUjoJRa8OlciCuHs28cjqeaSsXsNUPgnE07sABOCWP_s4bbubGc8oDycaS14vQ/exec";
        const scroller = document.getElementById('scroller');
        const marqueeContainer = document.getElementById('marquee-section');
        let currentPlaylist = [];
        let marqueeIndex = 0;

        function initMarquee() {
            fetch(MARQUEE_API)
                .then(res => res.json())
                .then(data => {
                    if (data && data.items) {
                        currentPlaylist = data.items;
                        // å¥—ç”¨è¨­å®šèƒŒæ™¯è‰² (å¦‚æœæœ‰)
                        if(data.settings && data.settings.BgColor) {
                            // æ³¨æ„ï¼šé€™è£¡åªæ”¹è·‘é¦¬ç‡ˆå€å¡ŠèƒŒæ™¯ï¼Œä¸æ”¹ Body
                            marqueeContainer.style.backgroundColor = data.settings.BgColor;
                        }
                        playNextMarquee();
                    } else {
                        scroller.innerText = "æš«ç„¡å…¬å‘Š";
                    }
                })
                .catch(() => scroller.innerText = "ç„¡æ³•é€£ç·šè‡³å…¬å‘Šä¼ºæœå™¨");
        }

        function playNextMarquee() {
            if (currentPlaylist.length === 0) return;
            if (marqueeIndex >= currentPlaylist.length) marqueeIndex = 0;

            const item = currentPlaylist[marqueeIndex];
            scroller.innerText = item.text;
            scroller.style.color = item.color || '#fff';
            
            // ç°¡å–®çš„å‹•ç•«æ¨¡æ“¬
            const containerWidth = marqueeContainer.offsetWidth;
            const textWidth = scroller.offsetWidth;
            let pos = containerWidth;
            
            scroller.style.transform = `translateX(${pos}px)`;
            scroller.style.transition = 'none';

            requestAnimationFrame(() => {
                // æ ¹æ“šå­—æ•¸æ±ºå®šé€Ÿåº¦ï¼Œç°¡å–®æ¨¡æ“¬
                const speed = 2; 
                function step() {
                    pos -= speed;
                    scroller.style.transform = `translateX(${pos}px)`;
                    if (pos < -textWidth) {
                        marqueeIndex++;
                        playNextMarquee();
                    } else {
                        requestAnimationFrame(step);
                    }
                }
                step();
            });
        }

        // ==========================================
        // 2. æ¯æ—¥é‡‘å¥é‚è¼¯
        // ==========================================
        const QUOTE_API = "https://script.google.com/macros/s/AKfycby3_BfpuqHlW0MtDyccQzu-UwFCLktYsTbtoRCLpE8nWdz2XfUBbMdeV1QTkZf7qofu2Q/exec";
        
        function fetchQuote() {
            const btn = document.getElementById('q-btn');
            const textEl = document.getElementById('q-text');
            const authorEl = document.getElementById('q-author');

            btn.disabled = true;
            btn.innerText = "è®€å–ä¸­...";
            textEl.style.opacity = 0;
            authorEl.style.opacity = 0;

            fetch(QUOTE_API)
                .then(res => res.json())
                .then(data => {
                    setTimeout(() => {
                        textEl.innerText = data.text;
                        authorEl.innerText = "â€” " + (data.author || "ä½šå");
                        textEl.style.opacity = 1;
                        authorEl.style.opacity = 1;
                        btn.disabled = false;
                        btn.innerText = "æ›ä¸€å¥";
                    }, 500);
                })
                .catch(err => {
                    textEl.innerText = "ç¶²è·¯éŒ¯èª¤æˆ– API é™åˆ¶";
                    textEl.style.opacity = 1;
                    btn.disabled = false;
                    btn.innerText = "é‡è©¦";
                });
        }

        // ==========================================
        // 3. AI èŠå¤©é‚è¼¯ (å›ºå®šå›è¦†)
        // ==========================================
        const FIXED_REPLY = 'æ—éƒç¿”æ„›ç”°èªæ¡'; // ä¾†è‡ªåŸç¨‹å¼ç¢¼ source: 292
        
        function handleChatSend() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';

            setTimeout(() => {
                addMessage(FIXED_REPLY, 'bot');
            }, 300);
        }

        function addMessage(text, type) {
            const container = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${type}`;
            msgDiv.innerText = text;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ==========================================
        // 4. æª”æ¡ˆåŠ å¯†/è§£é–å·¥å…· (V2)
        // ==========================================
        const HEADER_SEPARATOR = '::MIME::';

        async function processFile(mode) {
            const statusDiv = document.getElementById('crypto-status');
            const previewDiv = document.getElementById('crypto-preview');
            const fileInput = document.getElementById('fileInput');
            const password = document.getElementById('cryptoPwd').value;
            const file = fileInput.files[0];

            statusDiv.innerText = '';
            previewDiv.innerHTML = '';

            if (!file) return alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼');
            if (!password) return alert('è«‹è¼¸å…¥å¯†ç¢¼ï¼');

            statusDiv.innerText = 'è™•ç†ä¸­...';

            try {
                const fileBuffer = await file.arrayBuffer();
                let resultBuffer, resultName, mimeType = 'application/octet-stream';

                if (mode === 'encrypt') {
                    const originalMime = file.type || 'application/octet-stream';
                    const header = `${originalMime}${HEADER_SEPARATOR}`;
                    const headerBuffer = new TextEncoder().encode(header);
                    
                    const contentWithHeader = new Uint8Array(headerBuffer.length + fileBuffer.byteLength);
                    contentWithHeader.set(headerBuffer, 0);
                    contentWithHeader.set(new Uint8Array(fileBuffer), headerBuffer.length);

                    const salt = window.crypto.getRandomValues(new Uint8Array(16));
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const key = await deriveKey(password, salt);
                    
                    const encryptedContent = await window.crypto.subtle.encrypt(
                        { name: "AES-GCM", iv: iv }, key, contentWithHeader.buffer
                    );

                    const combinedBuffer = new Uint8Array(salt.byteLength + iv.byteLength + encryptedContent.byteLength);
                    combinedBuffer.set(salt, 0);
                    combinedBuffer.set(iv, 16);
                    combinedBuffer.set(new Uint8Array(encryptedContent), 28);
                    
                    resultBuffer = combinedBuffer;
                    resultName = file.name + ".enc";

                } else {
                    // è§£å¯†
                    const salt = new Uint8Array(fileBuffer.slice(0, 16));
                    const iv = new Uint8Array(fileBuffer.slice(16, 28));
                    const data = fileBuffer.slice(28);
                    const key = await deriveKey(password, salt);

                    try {
                        const decryptedBuffer = await window.crypto.subtle.decrypt(
                            { name: "AES-GCM", iv: iv }, key, data
                        );
                        const decryptedData = new Uint8Array(decryptedBuffer);
                        
                        // å°‹æ‰¾ MIME åˆ†éš”ç¬¦
                        let separatorPos = -1;
                        for(let i=0; i < decryptedData.length - HEADER_SEPARATOR.length; i++) {
                            const segment = new TextDecoder().decode(decryptedData.slice(i, i + HEADER_SEPARATOR.length));
                            if(segment === HEADER_SEPARATOR) {
                                separatorPos = i;
                                break;
                            }
                        }

                        if (separatorPos === -1) {
                             resultBuffer = decryptedBuffer;
                             resultName = file.name.replace(".enc", "");
                        } else {
                            const mimeHeader = new TextDecoder().decode(decryptedData.slice(0, separatorPos));
                            mimeType = mimeHeader;
                            resultBuffer = decryptedBuffer.slice(separatorPos + HEADER_SEPARATOR.length);
                            resultName = file.name.replace(".enc", "");
                        }

                    } catch (e) {
                        throw new Error("å¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆæå£");
                    }
                }

                downloadAndDisplay(resultBuffer, resultName, mimeType, previewDiv);
                statusDiv.innerText = `âœ… ${mode === 'encrypt' ? 'åŠ å¯†' : 'è§£é–'} å®Œæˆï¼`;

            } catch (error) {
                console.error(error);
                statusDiv.innerText = 'âŒ éŒ¯èª¤ï¼š' + error.message;
            }
        }

        async function deriveKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );
            return window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
            );
        }

        function downloadAndDisplay(data, filename, mimeType, container) {
            const blob = new Blob([data], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            
            if (mimeType.startsWith('image/')) {
                container.innerHTML = `<h4>åœ–ç‰‡é è¦½ï¼š</h4><img src="${url}" alt="Preview">`;
            }
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.innerText = `é»æ“Šä¸‹è¼‰: ${filename}`;
            a.style.display = 'block';
            a.style.marginTop = '10px';
            a.className = "quote-btn"; // å¤ç”¨æŒ‰é’®æ ·å¼
            a.style.textAlign = "center";
            a.style.textDecoration = "none";
            container.appendChild(a);
        }

        // ==========================================
        // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
        // ==========================================
        window.onload = function() {
            initMarquee();
            fetchQuote();
            
            // ç¶å®šèŠå¤©å®¤ Enter éµ
            document.getElementById('chatInput').addEventListener('keydown', function(e){
                if(e.key === 'Enter') handleChatSend();
            });
        };
    </script>
</body>
</html>
